#encoding:utf-8
#==============================================================================
# ■ Spriteset_Combo
#------------------------------------------------------------------------------
#  显示当前连击数的精灵组
#==============================================================================

require 'spriteset/spriteset_number'

#--------------------------------------------------------------------------
# ● Sprite_Combo
#
#   显示当前连击数的精灵，在 Spriteset_Combo 内部使用，实际上是精灵组
#--------------------------------------------------------------------------
class Sprite_Combo < Spriteset_Number
  #--------------------------------------------------------------------------
  # ● 获取位图
  #--------------------------------------------------------------------------
  def get_bitmap(bitmap); Cache.skin("combonumber"); end
  #--------------------------------------------------------------------------
  # ● 数字 X 坐标
  #--------------------------------------------------------------------------
  def pos_x; Skin_Setting.setting(:ComboNumberX); end
  #--------------------------------------------------------------------------
  # ● 数字 Y 坐标
  #--------------------------------------------------------------------------
  def pos_y; Skin_Setting.setting(:ComboNumberY); end
  #--------------------------------------------------------------------------
  # ● 数字间距的调整
  #--------------------------------------------------------------------------
  def pos_width; Skin_Setting.setting(:ComboNumberWidth); end
  #--------------------------------------------------------------------------
  # ● 数字 Z 高度
  #--------------------------------------------------------------------------
  def pos_z; 0; end
  #--------------------------------------------------------------------------
  # ● 居中对齐
  #--------------------------------------------------------------------------
  def pos_type; 1; end
end
#--------------------------------------------------------------------------
# ● Sprite_Combo2
#
#   显示当前连击数的精灵，在 Spriteset_Combo 内部使用，实际上是精灵组
#--------------------------------------------------------------------------
class Sprite_Combo2 < Sprite_Combo
  #--------------------------------------------------------------------------
  # ● 获取位图
  #--------------------------------------------------------------------------
  def get_bitmap(bitmap); Cache.skin("combonumber_l"); end
  #--------------------------------------------------------------------------
  # ● 数字 X 坐标
  #--------------------------------------------------------------------------
  def pos_x; Skin_Setting.setting(:ComboNumberX2); end
  #--------------------------------------------------------------------------
  # ● 数字 Y 坐标
  #--------------------------------------------------------------------------
  def pos_y; Skin_Setting.setting(:ComboNumberY2); end
  #--------------------------------------------------------------------------
  # ● 数字间距的调整
  #--------------------------------------------------------------------------
  def pos_width; Skin_Setting.setting(:ComboNumberWidth2); end
end
#--------------------------------------------------------------------------
# ● Sprite_Mtaikoflower
#
#   连击达到一定数目时显示花朵的精灵，在 Spriteset_Combo 内部使用
#--------------------------------------------------------------------------
class Sprite_Mtaikoflower < Sprite_Anime
  #--------------------------------------------------------------------------
  # ● 设置精灵的位图
  #--------------------------------------------------------------------------
  def get_bitmap(bitmap); Cache.skin("mtaikoflower"); end
  #--------------------------------------------------------------------------
  # ● 显示精灵
  #--------------------------------------------------------------------------
  def show
    @frame = 0
    set_frame
    super
  end
end
#--------------------------------------------------------------------------
# ● Spriteset_Combo
#
#   显示当前连击数的精灵组
#--------------------------------------------------------------------------
class Spriteset_Combo < Spriteset_M5
  #--------------------------------------------------------------------------
  # ● 初始化
  #--------------------------------------------------------------------------
  def initialize(viewport = nil)
    @combo1 = Sprite_Combo.new(viewport)
    @combo2 = Sprite_Combo2.new(viewport)
    @flower = Sprite_Mtaikoflower.new(viewport,
      {x: pos_x, y: pos_y, z: pos_z},{duration: duration_time})
    @combo_number = 0
    hide
  end
  #--------------------------------------------------------------------------
  # ● 花朵X坐标
  #--------------------------------------------------------------------------
  def pos_x; Skin_Setting.setting(:MtaikoflowerX); end
  #--------------------------------------------------------------------------
  # ● 花朵Y坐标
  #--------------------------------------------------------------------------
  def pos_y; Skin_Setting.setting(:MtaikoflowerY); end
  #--------------------------------------------------------------------------
  # ● 花朵Z坐标
  #--------------------------------------------------------------------------
  def pos_z; -1; end
  #--------------------------------------------------------------------------
  # ● 花朵显示时间
  #--------------------------------------------------------------------------
  def duration_time; 60; end
  #--------------------------------------------------------------------------
  # ● 更新
  #--------------------------------------------------------------------------
  def update
    super
    @flower.update
    return if @combo_number == Taiko.combo
    @combo_number = Taiko.combo
    if @combo_number < 10 then hide
    else
      @flower.show if @combo_number % 50 == 0
      if @combo_number < 50 then @combo1.show(@combo_number)
      else
        @combo1.clear
        @combo2.show(@combo_number)
      end
    end
  end
  #--------------------------------------------------------------------------
  # ● 隐藏
  #--------------------------------------------------------------------------
  def hide
    @combo1.clear
    @combo2.clear
    @flower.hide
  end
  #--------------------------------------------------------------------------
  # ● 释放
  #--------------------------------------------------------------------------
  def dispose
    super
    @combo1.dispose
    @combo2.dispose
    @flower.dispose
  end
end